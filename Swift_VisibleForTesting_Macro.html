<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <title>Swift macro : @VisibleForTesting &#8211; Bloggure</title>
    <meta
      name="description"
      content="Multi author blog about programming, computing and geek stuff"
    />
    <meta name="keywords" content="ios, test, macro tip" />

    <!-- Open Graph -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Swift macro : @VisibleForTesting" />
    <meta
      property="og:description"
      content="Multi author blog about programming, computing and geek stuff"
    />
    <meta
      property="og:url"
      content="http://www.bloggure.info/Swift_VisibleForTesting_Macro"
    />
    <meta property="og:site_name" content="Bloggure" />

    <link
      rel="canonical"
      href="http://www.bloggure.info/Swift_VisibleForTesting_Macro"
    />
    <link
      href="http://www.bloggure.info/feed.xml"
      type="application/atom+xml"
      rel="alternate"
      title="Bloggure Feed"
    />

    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- For all browsers -->
    <link
      rel="stylesheet"
      href="http://www.bloggure.info/assets/css/main.css"
    />
    <!-- Webfonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic"
      rel="stylesheet"
      type="text/css"
    />

    <meta http-equiv="cleartype" content="on" />

    <!-- Load Modernizr -->
    <script src="http://www.bloggure.info/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

    <!-- Icons -->
    <!-- 16x16 -->
    <link rel="shortcut icon" href="http://www.bloggure.info/favicon.ico" />
    <!-- 32x32 -->
    <link rel="shortcut icon" href="http://www.bloggure.info/favicon.png" />
    <!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
    <link
      rel="apple-touch-icon-precomposed"
      href="http://www.bloggure.info/images/apple-touch-icon-precomposed.png"
    />
    <!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="72x72"
      href="http://www.bloggure.info/images/apple-touch-icon-72x72-precomposed.png"
    />
    <!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="114x114"
      href="http://www.bloggure.info/images/apple-touch-icon-114x114-precomposed.png"
    />
    <!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="144x144"
      href="http://www.bloggure.info/images/apple-touch-icon-144x144-precomposed.png"
    />
  </head>

  <body id="post">
    <!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

    <div class="entry-header">
      <header class="header-title">
        <div class="header-title-wrap">
          <h1 class="entry-title" itemprop="name">
            <a href="http://www.bloggure.info/">Bloggure</a>
          </h1>
        </div>
        <!-- /.header-title-wrap -->
      </header>
    </div>

    <div id="main" role="main">
      <article class="hentry">
        <div class="entry-content">
          <header>
            <div class="entry-meta">
              <span class="entry-date date published updated"
                ><time
                  datetime="2024-04-19T00:00:00+02:00"
                  itemprop="datePublished"
                  ><a
                    href="http://www.bloggure.info/Swift_VisibleForTesting_Macro"
                    >April 19, 2024</a
                  ></time
                ></span
              ><span
                class="author vcard"
                itemprop="author"
                itemscope
                itemtype="http://schema.org/Person"
                ><span itemprop="name" class="fn"
                  ><a
                    href="http://www.bloggure.info/cgatay"
                    title="About cgatay"
                    itemprop="url"
                    >cgatay</a
                  ></span
                ></span
              >&nbsp; &bull; &nbsp;<span class="entry-comments"
                ><a
                  href="http://www.bloggure.info/Swift_VisibleForTesting_Macro#disqus_thread"
                  >Comment</a
                ></span
              >
            </div>
            <!-- /.entry-meta -->

            <h1 class="entry-title" itemprop="name">
              <a
                href="http://www.bloggure.info/Swift_VisibleForTesting_Macro"
                rel="bookmark"
                title="Swift macro : @VisibleForTesting"
                itemprop="url"
                >Swift macro : @VisibleForTesting</a
              >
            </h1>
          </header>
          <p>
            As an ancient Java developer, I’ve learned to use a set of
            annotations to bring meta programming in my projects.
          </p>

          <p>
            Meta programming can be considered as an orthogonal thing to your
            code, you can inject code to log things, to wrap execution in a
            transaction or simply provide some context to your fellow developer.
          </p>

          <p>
            One of my favorite context providing annotation at this time was
            brought by Google-Annotations package :
            <a
              href="https://guava.dev/releases/19.0/api/docs/com/google/common/annotations/VisibleForTesting.html"
              ><code>@VisibleForTesting</code></a
            >
          </p>

          <p>
            Its goal is rather simple: provide the context that the visibility
            of the variable / method is not as restricted as it should be, but
            this is for the sake of testing.
          </p>

          <p>
            When going back to my loved XCode (just kidding), I miss these kind
            of useful information.
          </p>

          <p>
            Of course you can add a comment, that maybe someone will read if he
            begins to wonder why the visibility is too important.
          </p>

          <figure class="highlight">
            <pre><code class="language-swift" data-lang="swift"><span></span><span class="c1">// this method should be private but we want to access it from unit test code  </span>
<span class="kd">func</span> <span class="nf">doStuff</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span></code></pre>
          </figure>

          <p>
            You can also play with the deprecation annotation to trigger a
            warning (one more to add and parse with your eyes…)
          </p>

          <figure class="highlight">
            <pre><code class="language-swift" data-lang="swift"><span></span><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;This is visible for testing&quot;</span><span class="p">)</span>  
<span class="kd">var</span> <span class="nv">myState</span><span class="p">:</span> <span class="n">State</span></code></pre>
          </figure>

          <p>
            But one thing I was really missing is the ability to really set the
            proper visibility on my fields while keeping the testability.
          </p>

          <p>
            Recently,
            <a href="https://www.swift.org/blog/swift-5.9-released/"
              >Swift 5.9 had added Macro support</a
            >. Macros can be seen as ways to generate code based on specific
            instructions (this brings back old Java-apt memories).
          </p>

          <h1 id="macro-types">Macro types</h1>

          <p>
            There are multiples macro types, whether they can attach to fields,
            and depending on what they can do:
          </p>

          <ul>
            <li>Providing accessors</li>
            <li>Generating code alongside the annotated field</li>
            <li>Generating code “in-place”</li>
          </ul>

          <p>There are two ways of calling macros :</p>

          <ul>
            <li>Attached ones with <code>@MacroName</code></li>
            <li>Freeform ones with <code>#MacroName</code></li>
          </ul>

          <p>
            I will not enter the details of each type and implementation, you
            will see more on this later here and can scout on GitHub
            repositories for inspiration.
          </p>

          <p>
            Attached macros are written with a leading @ and can generate code
            alongside some of our declaration. This allowed me to introduce my
            own <code>@VisibleForTesting</code> for swift implementation.
          </p>

          <p>
            The idea behind this is really simple, generate specific code with
            public visibility that wraps call to the “non-exposed” real method.
          </p>

          <p>
            This way we get the best of both worlds, we keep our fields private,
            we tell our colleagues that this field is available for testing and
            we are able to test it properly.
          </p>

          <h1 id="what-does-it-look-like-">What does it look like ?</h1>

          <p>
            To use this library, you need to add an SPM dependency on this
            repository:
            <a href="https://github.com/CedricGatay/SwiftMacroUtils"
              >https://github.com/CedricGatay/SwiftMacroUtils</a
            >
          </p>

          <figure class="highlight">
            <pre><code class="language-swift" data-lang="swift"><span></span><span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/CedricGatay/SwiftMacroUtils&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="s">&quot;main&quot;</span><span class="p">)</span></code></pre>
          </figure>

          <p>
            Then, let’s say you want to give access for testing to the name var
            of the Dog struct to your testing code, you simply need to do the
            following
          </p>

          <figure class="highlight">
            <pre><code class="language-swift" data-lang="swift"><span></span><span class="kd">struct</span> <span class="nc">Dog</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">VisibleForTesting</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
<span class="p">}</span></code></pre>
          </figure>

          <p>
            Under the hood, the macro will generate a public accessor that you
            will be able to use in your tests
          </p>

          <figure class="highlight">
            <pre><code class="language-swift" data-lang="swift"><span></span><span class="kd">public</span> <span class="kd">var</span> <span class="nv">__test_name</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">{</span>
    <span class="kr">get</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span>
    <span class="p">}</span>
    <span class="kr">set</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">newValue</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
          </figure>

          <p>
            The same goes for <code>let</code>, <code>func</code>, and
            <code>init</code> . The only specific thing to keep in mind that if
            you annotate a <code>class</code> initializer, you need to mark it
            as <code>required</code>, otherwise the build will fail (but a nice
            comment will tell you why).
          </p>

          <footer class="entry-meta">
            <span class="entry-tags"
              ><a
                href="http://www.bloggure.info/tags/#ios"
                title="Pages tagged ios"
                class="tag"
                ><span class="term">ios</span></a
              ><a
                href="http://www.bloggure.info/tags/#test"
                title="Pages tagged test"
                class="tag"
                ><span class="term">test</span></a
              ><a
                href="http://www.bloggure.info/tags/#macro tip"
                title="Pages tagged macro tip"
                class="tag"
                ><span class="term">macro tip</span></a
              ></span
            >

            <div class="social-share">
              <ul class="socialcount socialcount-small inline-list">
                <li class="facebook">
                  <a
                    href="https://www.facebook.com/sharer/sharer.php?u=http://www.bloggure.info/Swift_VisibleForTesting_Macro"
                    title="Share on Facebook"
                    ><span class="count"
                      ><i class="fa fa-facebook-square"></i> Like</span
                    ></a
                  >
                </li>
                <li class="twitter">
                  <a
                    href="https://twitter.com/intent/tweet?text=http://www.bloggure.info/Swift_VisibleForTesting_Macro"
                    title="Share on Twitter"
                    ><span class="count"
                      ><i class="fa fa-twitter-square"></i> Tweet</span
                    ></a
                  >
                </li>
              </ul>
            </div>
            <!-- /.social-share -->
          </footer>
        </div>
        <!-- /.entry-content -->
        <section id="disqus_thread"></section>
        <!-- /#disqus_thread -->
        <div class="read-more">
          <div class="read-more-header">
            <a
              href="http://www.bloggure.info/iOS-DarkModeBackground-App-Switcher"
              class="read-more-btn"
              >Read More</a
            >
          </div>
          <!-- /.read-more-header -->
          <div class="read-more-content">
            <h3>
              <a
                href="http://www.bloggure.info/Tuist_build_test_schemes"
                title="Tuist build test schemes"
                >Tuist build test schemes</a
              >
            </h3>
            <p>
              Tuist build test schemesI use tuist to build most of my iOS
              projects nowadays. And like every good software engineer I test
              the code that...&hellip;
              <a href="http://www.bloggure.info/Tuist_build_test_schemes"
                >Continue reading</a
              >
            </p>
          </div>
          <!-- /.read-more-content -->

          <div class="read-more-list">
            <div class="list-item">
              <h4>
                <a
                  href="http://www.bloggure.info/Module_Registration_Swift"
                  title="Swift module registration"
                  >Swift module registration</a
                >
              </h4>
              <span>Published on April 28, 2025</span>
            </div>
            <!-- /.list-item -->

            <div class="list-item">
              <h4>
                <a
                  href="http://www.bloggure.info/iOS-DarkModeBackground-App-Switcher"
                  title="Dark Mode iOS Snapshot"
                  >Dark Mode iOS Snapshot</a
                >
              </h4>
              <span>Published on January 10, 2021</span>
            </div>
            <!-- /.list-item -->
          </div>
          <!-- /.read-more-list -->
        </div>
        <!-- /.read-more -->
      </article>
    </div>
    <!-- /#main -->

    <div class="footer-wrapper">
      <footer role="contentinfo">
        <span
          >&copy; 2025 . Powered by
          <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using a theme
          based on
          <a
            href="https://mademistakes.com/work/hpstr-jekyll-theme/"
            rel="nofollow"
            >HPSTR</a
          >.</span
        >
      </footer>
    </div>
    <!-- /.footer-wrapper -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
      window.jQuery ||
        document.write(
          '<script src="http://www.bloggure.info/assets/js/vendor/jquery-1.9.1.min.js"><\/script>'
        );
    </script>
    <script src="http://www.bloggure.info/assets/js/scripts.min.js"></script>

    <!-- Asynchronous Google Analytics snippet -->
    <script>
      (function (i, s, o, g, r, a, m) {
        i["GoogleAnalyticsObject"] = r;
        (i[r] =
          i[r] ||
          function () {
            (i[r].q = i[r].q || []).push(arguments);
          }),
          (i[r].l = 1 * new Date());
        (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
      })(
        window,
        document,
        "script",
        "//www.google-analytics.com/analytics.js",
        "ga"
      );

      ga("create", "UA-11718843-3", "auto");
      ga("require", "linkid", "linkid.js");
      ga("send", "pageview");
    </script>

    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = "thereisnoplacelike1"; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
        var dsq = document.createElement("script");
        dsq.type = "text/javascript";
        dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (
          document.getElementsByTagName("head")[0] ||
          document.getElementsByTagName("body")[0]
        ).appendChild(dsq);
      })();

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
        var s = document.createElement("script");
        s.async = true;
        s.type = "text/javascript";
        s.src = "//" + disqus_shortname + ".disqus.com/count.js";
        (
          document.getElementsByTagName("HEAD")[0] ||
          document.getElementsByTagName("BODY")[0]
        ).appendChild(s);
      })();
    </script>
    <noscript
      >Please enable JavaScript to view the
      <a href="http://disqus.com/?ref_noscript"
        >comments powered by Disqus.</a
      ></noscript
    >
    <a href="http://disqus.com" class="dsq-brlink"
      >comments powered by <span class="logo-disqus">Disqus</span></a
    >
  </body>
</html>
