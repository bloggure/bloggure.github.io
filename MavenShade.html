<p>
  Lors de nos développements, nous reposons beaucoup sur des projets externes
  qui nous fournissent énormément de services utiles. Dans un récent projet,
  nous avons eu besoin de faire fonctionner Neo4j conjointement à ElasticSearch.
  Jusqu’ici, aucun soucis n’est à déplorer, mais nous avions une exigence
  particulière : il fallait que l’application puisse démarrer automatiquement un
  serveur Neo4J ainsi qu’un serveur ElasticSearch sur les postes de
  développements (ainsi que pour les tests d’intégration).
</p>

<h2 id="problème-existant">Problème existant</h2>

<p>
  Les deux outils que nous utilisons se basent sur Apache Lucene pour toute la
  partie indexation et accès aux données. Mais, et c’est là que le problème se
  situe, ils n’utilisent pas les mêmes versions de Lucene.
</p>

<pre><code>&lt;!-- Extrait du pom d'ElasticSearch --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;
    &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;
    &lt;version&gt;4.9.0&lt;/version&gt;
    &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<hr />

<pre><code>&lt;!-- Extrait du pom de Neo4j --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;
    &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;
    &lt;version&gt;3.6.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>
  ElasticSearch utilise la version 4.9.0, alors que Neo4J utilise la version
  3.6.2. Ainsi, en fonction du bon vouloir du <code>Classloader</code> qui sera
  utilisé par l’application, il se peut qu’ElasticSearch ou Neo4J refuse de
  fonctionner. La difficulté pour comprendre et détecter le problème est qu’il
  se manifeste souvent par un obscur <code>NoClassDefFoundError</code> ou
  <code>NoSuchMethodError</code> qui n’est pas des plus explicites (d’autant
  plus lorsque notre IDE nous montre une version qui contient ledit symbole non
  trouvé).
</p>

<h2 id="solution-de-contournement">Solution de contournement</h2>

<p>
  Le conflit est assez simple à contourner une fois qu’on a compris ce qui se
  passe. En fait, il y a deux classes portant le même nom dans les classes
  chargées, par exemple <code>org.lucene.MaClass</code>, l’une effaçant l’autre
  aux yeux du <code>ClassLoader</code>. Une pratique courante est de renommer
  (ou relocate) le package de base d’une bibliothèque utilisée et de l’inclure
  dans le fichier de package du projet, le plugin <code>maven-shade</code> est
  conçu dans cette optique. Le choix fait est de renommer la dépendance Lucene
  dans Neo4J pour notre part, ainsi, nous avons forké le projet et configuré le
  plugin <code>shade</code> pour qu’il inclue le contenu de la dépendance
  d’Apache Lucene et qu’il fasse le renommage de
  <code>org.apache.lucene</code> en <code>shaded.org.apache.lucene</code>.
</p>

<pre><code> &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.2&lt;/version&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;phase&gt;package&lt;/phase&gt;
                &lt;goals&gt;
                    &lt;goal&gt;shade&lt;/goal&gt;
                &lt;/goals&gt;
                &lt;configuration&gt;
                    &lt;createDependencyReducedPom&gt;true&lt;/createDependencyReducedPom&gt;

                    &lt;artifactSet&gt;
                        &lt;includes&gt;
                            &lt;include&gt;org.apache.lucene:*&lt;/include&gt;
                        &lt;/includes&gt;
                    &lt;/artifactSet&gt;
                    &lt;relocations&gt;
                        &lt;relocation&gt;
                            &lt;pattern&gt;org.apache.lucene&lt;/pattern&gt;
                            &lt;shadedPattern&gt;shaded.org.apache.lucene&lt;/shadedPattern&gt;
                        &lt;/relocation&gt;
                    &lt;/relocations&gt;
                &lt;/configuration&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
  &lt;/plugin&gt;
</code></pre>

<h2 id="déploiement-et-nommage">Déploiement et nommage</h2>

<p>
  Pour ne pas polluer les dépôts, le numéro de version modifié a été postfixé
  par <code>-shaded</code>. Le déploiement a été fait sur un dépôt Maven qui est
  en fait un simple repository Github. Le commit correspondant à cette
  modification
  <a
    href="https://github.com/CedricGatay/neo4j/commit/452f58fca69ffe3b1d0eab6261b8342f8da95889"
    >est consultable ici</a
  >.
</p>
