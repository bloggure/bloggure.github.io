<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <title>Bloggure</title>
    <meta
      name="description"
      content="Multi author blog about programming, computing and geek stuff"
    />

    <!-- Open Graph -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Bloggure" />
    <meta
      property="og:description"
      content="Multi author blog about programming, computing and geek stuff"
    />
    <meta property="og:url" content="http://www.bloggure.info/page3/" />
    <meta property="og:site_name" content="Bloggure" />

    <link rel="canonical" href="http://www.bloggure.info/page3/" />
    <link
      href="http://www.bloggure.info/feed.xml"
      type="application/atom+xml"
      rel="alternate"
      title="Bloggure Feed"
    />

    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- For all browsers -->
    <link
      rel="stylesheet"
      href="http://www.bloggure.info/assets/css/main.css"
    />
    <!-- Webfonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic"
      rel="stylesheet"
      type="text/css"
    />

    <meta http-equiv="cleartype" content="on" />

    <script>
      document.documentElement.className = document.documentElement.className.replace(
        /\bno-js\b/,
        "js"
      );
    </script>

    <!-- Icons -->
    <!-- 16x16 -->
    <link rel="shortcut icon" href="http://www.bloggure.info/favicon.ico" />
    <!-- 32x32 -->
    <link rel="shortcut icon" href="http://www.bloggure.info/favicon.png" />
    <!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
    <link
      rel="apple-touch-icon-precomposed"
      href="http://www.bloggure.info/images/apple-touch-icon-precomposed.png"
    />
    <!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="72x72"
      href="http://www.bloggure.info/images/apple-touch-icon-72x72-precomposed.png"
    />
    <!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="114x114"
      href="http://www.bloggure.info/images/apple-touch-icon-114x114-precomposed.png"
    />
    <!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="144x144"
      href="http://www.bloggure.info/images/apple-touch-icon-144x144-precomposed.png"
    />
  </head>

  <body id="post-index">
    <!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

    <div class="entry-header">
      <div class="header-title">
        <div class="header-title-wrap">
          <h1 itemprop="name">
            <a href="http://www.bloggure.info/">Bloggure</a>
          </h1>
          <h2><a href="/page3/"></a></h2>
        </div>
        <!-- /.header-title-wrap -->
      </div>
      <!-- /.header-title -->
    </div>
    <!-- /.entry-header -->

    <div id="main" role="main">
      <article
        class="hentry"
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <header>
          <div class="entry-meta">
            <span class="entry-date date published updated"
              ><time
                datetime="2020-12-01T00:00:00+01:00"
                itemprop="datePublished"
                ><a href="http://www.bloggure.info/Revival"
                  >December 01, 2020</a
                ></time
              ></span
            ><span
              class="author vcard"
              itemprop="author"
              itemscope
              itemtype="http://schema.org/Person"
              ><span itemprop="name" class="fn"
                ><a
                  href="http://www.bloggure.info/cgatay"
                  title="About cgatay"
                  itemprop="url"
                  >cgatay</a
                ></span
              ></span
            >&nbsp; &bull; &nbsp;<span class="entry-comments"
              ><a href="http://www.bloggure.info/Revival#disqus_thread"
                >Comment</a
              ></span
            >
          </div>
          <!-- /.entry-meta -->

          <h1 class="entry-title" itemprop="name">
            <a
              href="http://www.bloggure.info/Revival"
              rel="bookmark"
              title="Bloggure revival"
              itemprop="url"
              >Bloggure revival</a
            >
          </h1>
        </header>
        <div class="entry-content" itemprop="description">
          <h1 id="its-been-a-long-time">It’s been a long time</h1>

          <p>It’s been a very long time since last post (5 years…).</p>

          <p>
            I am convinced that blogging is useful, at least for my present
            self, and for my future self that tends to lose track of important
            things.
          </p>

          <h2 id="what-will-this-be-about-">What will this be about ?</h2>

          <p>
            In the <em>past</em> I blogged a lot about Java / Maven and so on,
            my days have evolved to another languages, so I guess there will be
            less JVM things (but may be a few Kotlin) and more Swift / Rust on
            the other end.
          </p>

          <h2 id="technical-stack">Technical stack</h2>

          <p>
            In a blog reboot, we (I mean dev) like to follow the latest trend
            and migrate our blog system to latest hype stack. I will avoid this
            and focus on writing instead, so the site stays in its 15’ shape:
          </p>

          <ul>
            <li><a href="http://jekyllrb.com/">jekyll</a></li>
            <li><a href="https://pages.github.com">github-pages</a></li>
            <li>
              markdown (I think <code>jenkins-asciidoc</code> is around the
              corner though)
            </li>
            <li>
              <a href="https://actions.github.com">github actions</a> for
              building
            </li>
          </ul>

          <p>
            The sole new thing is that I’m trying to write using
            <a href="https://gitpod.io">gitpod.io</a> to get a distraction free
            environment.
          </p>
        </div>
        <!-- /.entry-content -->
      </article>
      <!-- /.hentry -->

      <article
        class="hentry"
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <header>
          <div class="entry-meta">
            <span class="entry-date date published updated"
              ><time
                datetime="2018-03-13T00:00:00+01:00"
                itemprop="datePublished"
                ><a href="http://www.bloggure.info/FirebasePListXCode"
                  >March 13, 2018</a
                ></time
              ></span
            ><span
              class="author vcard"
              itemprop="author"
              itemscope
              itemtype="http://schema.org/Person"
              ><span itemprop="name" class="fn"
                ><a
                  href="http://www.bloggure.info/Cedric"
                  title="About Cedric"
                  itemprop="url"
                  >Cedric</a
                ></span
              ></span
            >
          </div>
          <!-- /.entry-meta -->

          <h1 class="entry-title" itemprop="name">
            <a
              href="http://www.bloggure.info/FirebasePListXCode"
              rel="bookmark"
              title="Firebase + XCode"
              itemprop="url"
              >Firebase + XCode</a
            >
          </h1>
        </header>
        <div class="entry-content" itemprop="description">
          <div class="paragraph">
            <p>
              Il est courant maintenant d&#8217;utiliser Firebase dans les
              applications mobiles. Que ce soit pour la partie statistiques, les
              notifications ou le reporting des <em>crashes</em>.
              L&#8217;intégration est très facile, mais peut devenir compliquée
              dès lors qu&#8217;on manipule des <em>target</em> différentes avec
              des configurations différentes. Cet article va vous détailler une
              façon simple mais efficace de gérer ces différences.
            </p>
          </div>
          <div class="sect1">
            <h2 id="multiples-fichiers-plist">
              Multiples fichiers <code>plist</code>
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Les fichiers <code>plist</code> sont des fichiers XML de
                  configuration pour XCode. Lors de la création d&#8217;un
                  projet dans Firebase, il est possible de récupérer une version
                  générée contenant les bonnes variables pour votre projet. Le
                  problème qui peut se produire est lorsqu&#8217;on génère
                  plusieurs livrables avec des configurations qui doivent être
                  différentes grace aux <em>target</em>. Il n&#8217;est pas
                  possible, ni confortable, de gérer le cas de plusieurs
                  fichiers <code>plist</code> dans les sources. La redéfinition
                  du nom du fichier à faire utiliser par Firebase ne marche pas
                  à tous les coups et il a tendance à aller lire la valeur par
                  défaut <code>GoogleService-Info.plist</code>.
                </p>
              </div>
              <div class="paragraph">
                <p>
                  L&#8217;idée est donc d&#8217;utiliser un script au build qui
                  se chargera de configurer correctement le fichier
                  <code>plist</code> qui sera inclu dans le livrable.
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="première-étape-variabilisation">
              Première étape : variabilisation
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Pour être capable de générer le fichier
                  <code>plist</code> correctement, il est nécessaire de le
                  variabiliser. Dans mon cas, j&#8217;ai identifié les valeurs
                  suivantes qui devaient être variabilisées:
                </p>
              </div>
              <div class="ulist">
                <ul>
                  <li>
                    <p>GOOGLE_APP_ID</p>
                  </li>
                  <li>
                    <p>BUNDLE_ID</p>
                  </li>
                  <li>
                    <p>CLIENT_ID</p>
                  </li>
                  <li>
                    <p>REVERSED_CLIENT_ID</p>
                  </li>
                </ul>
              </div>
              <div class="paragraph">
                <p>
                  J&#8217;ai donc ajouté des variables à la configuration de mon
                  build pour représenter ces valeurs qui doivent être
                  personnalisées. J&#8217;utilise des fichiers
                  <code>.xcconfig</code> mais ceci fonctionne également avec
                  l&#8217;ajout manuel (dans
                  <code
                    >Build Settings &gt; + &gt; Add User-Defined settings</code
                  >)
                </p>
              </div>
              <div class="paragraph">
                <p>
                  Unresolved directive in #excerpt -
                  include::site/static/lightbox.adoc[]
                </p>
              </div>
              <div class="paragraph">
                <p>
                  En plus de ça, j&#8217;ai modifié le fichier
                  <code>GoogleService-Info.plist</code> téléchargé sur Firebase
                  pour enlever les éléments qui allaient être remplacés à terme.
                  Plus exactement, j&#8217;ai remplacé les valeurs par des
                  chaînes du type <code>WILL BE REPLACED AT BUILD TIME</code>,
                  qui me permettent facilement de me rendre compte d&#8217;un
                  oubli de configuration.
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="deuxième-étape-génération-du-fichier">
              Deuxième étape : génération du fichier
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Une fois le fichier et l&#8217;environnement préparé, il ne
                  reste qu&#8217;à générer la version finale. Pour se faire, je
                  me base sur le système de <em>build</em> de XCode qui permet
                  de définir simplement des étapes. Les variables définies dans
                  la configuration du projet sont en effet disponibles
                  simplement lors de l&#8217;exécution des étapes de
                  <em>build</em>. En utilisant l&#8217;outil
                  <code>defaults</code> inclu dans macOS pour la manipulation
                  des fichiers <code>plist</code>, il est donc facile de définir
                  les valeurs attendues dans le fichier. J&#8217;ai ainsi
                  rajouté une étape <em>shell</em> script correspondant à ceci
                  dans le processus de <em>build</em>.
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-shell" data-lang="shell">defaults write "${BUILT_PRODUCTS_DIR}/${PRODUCT_NAME}.app/GoogleService-Info.plist" GOOGLE_APP_ID ${GOOGLE_APP_ID}
defaults write "${BUILT_PRODUCTS_DIR}/${PRODUCT_NAME}.app/GoogleService-Info.plist" BUNDLE_ID ${PKG_IDENTIFIER}
defaults write "${BUILT_PRODUCTS_DIR}/${PRODUCT_NAME}.app/GoogleService-Info.plist" CLIENT_ID ${CLIENT_ID}
defaults write "${BUILT_PRODUCTS_DIR}/${PRODUCT_NAME}.app/GoogleService-Info.plist" REVERSED_CLIENT_ID ${REVERSED_CLIENT_ID}</code></pre>
                </div>
              </div>
              <div class="paragraph">
                <p>
                  Enfin, il faut ordonner cette étape de <em>build</em> après
                  celle de copie des ressources, pour effectuer la modification
                  uniquement dans le fichier binaire de l&#8217;application et
                  non dans les sources du projet.
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="bénéfices">Bénéfices</h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Il est donc facile de disposer de configuration différente de
                  Firebase entre le <em>debug</em> et la <em>release</em> par
                  exemple. Ainsi vous pouvez tester l&#8217;envoi de
                  notification, par exemple, sans risquer de polluer des
                  utilisateurs de production, ou activer le
                  <em>crash reporting</em> uniquement en production par exemple.
                </p>
              </div>
            </div>
          </div>
        </div>
        <!-- /.entry-content -->
      </article>
      <!-- /.hentry -->

      <article
        class="hentry"
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <header>
          <div class="entry-meta">
            <span class="entry-date date published updated"
              ><time
                datetime="2016-01-20T00:00:00+01:00"
                itemprop="datePublished"
                ><a href="http://www.bloggure.info/JenkinsWorkflow"
                  >January 20, 2016</a
                ></time
              ></span
            ><span
              class="author vcard"
              itemprop="author"
              itemscope
              itemtype="http://schema.org/Person"
              ><span itemprop="name" class="fn"
                ><a
                  href="http://www.bloggure.info/Cedric"
                  title="About Cedric"
                  itemprop="url"
                  >Cedric</a
                ></span
              ></span
            >
          </div>
          <!-- /.entry-meta -->

          <h1 class="entry-title" itemprop="name">
            <a
              href="http://www.bloggure.info/JenkinsWorkflow"
              rel="bookmark"
              title="Jenkins Workflow Plugin"
              itemprop="url"
              >Jenkins Workflow Plugin</a
            >
          </h1>
        </header>
        <div class="entry-content" itemprop="description">
          <div class="paragraph">
            <p>
              Un des points génants lors de l&#8217;utilisation de Jenkins est
              le coté volatile de la configuration des jobs de builds. Il est
              souvent nécessaire de jouer de click-click pour faire la
              configuration des jobs sur Jenkins et de se reposer sur un plugin
              permettant de versionner, autant que possible, les configurations
              utilisées.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Mais, une fois que vous aurez lu cet article, vous vous rendrez
              compte que c&#8217;est le passé. Attention toutefois, cet article
              parle de Jenkins, de Docker et de Groovy, n&#8217;ayez pas peur,
              tout est <em>presque</em> trop simple&#8230;&#8203;
            </p>
          </div>
          <div class="sect1">
            <h2 id="prérequis-jenkins">Prérequis Jenkins</h2>
            <div class="sectionbody">
              <div class="sect2">
                <h3 id="jenkins-avec-accès-à-docker">
                  Jenkins avec accès à Docker
                </h3>
                <div class="paragraph">
                  <p>
                    Nous avons l&#8217;habitude d&#8217;utiliser un Jenkins
                    lancé dans un container depuis quelques temps.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    Nous utilisons l&#8217;image maintenue par
                    <a href="https://agileek.github.io/">Michael Bitard</a>
                    <a href="https://hub.docker.com/r/agileek/docker-jenkins/"
                      ><code>agileek/docker-jenkins</code></a
                    >.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    Nous lançons cette image en lui fournissant de quoi exécuter
                    le binaire docker client sans soucis :
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre
                      class="highlight"
                    ><code class="language-bash" data-lang="bash">docker run
       -d --restart="always" --name jenkins
       -u $(id -u):$(getent group docker | cut -d: -f3) # <b class="conum">(1)</b>
       -p 8080:8080
       -v /var/jenkins_home:/var/jenkins_home # <b class="conum">(2)</b>
       -v $(which docker):/usr/bin/docker # <b class="conum">(3)</b>
       -v /var/run/docker.sock:/var/run/docker.sock # <b class="conum">(4)</b>
       -v /usr/lib/x86_64-linux-gnu/libapparmor.so.1:/lib/x86_64-linux-gnu/libapparmor.so.1 # <b class="conum">(5)</b>
       agileek/docker-jenkins # <b class="conum">(6)</b></code></pre>
                  </div>
                </div>
                <div class="colist arabic">
                  <ol>
                    <li>
                      <p>
                        Le container est lancé avec l&#8217;utilisateur courant
                        et le groupe <code>docker</code> pour pouvoir accéder au
                        <code>docker.sock</code>
                      </p>
                    </li>
                    <li>
                      <p>
                        Pour éviter les incohérences de chemin, le chemin racine
                        du jenkins est le même en dehors et dans le container
                      </p>
                    </li>
                    <li>
                      <p>
                        Le binaire docker du système est fourni dans
                        l&#8217;image
                      </p>
                    </li>
                    <li>
                      <p>
                        Le socket docker est également fourni pour que le client
                        puisse "parler" au démon
                      </p>
                    </li>
                    <li>
                      <p>
                        La bibliotheque apparmor est nécessaire pour le bon
                        fonctionnement de docker client
                      </p>
                    </li>
                  </ol>
                </div>
              </div>
              <div class="sect2">
                <h3 id="jenkins-workflow-plugin">Jenkins workflow plugin</h3>
                <div class="paragraph">
                  <p>
                    Pour utiliser la suite des éléments, vous aurez besoin des
                    plugins gérant la notion de <em>workflow</em> dans Jenkins :
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    Unresolved directive in #excerpt -
                    include::site/static/lightbox.adoc[]
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    Ensuite, il nous est possible de créer un job de
                    construction de type <em>workflow</em> :
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    Unresolved directive in #excerpt -
                    include::site/static/lightbox.adoc[]
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="premier-job-workflow">Premier job <em>Workflow</em></h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Ensuite, c&#8217;est là que la magie opère, plutôt que de
                  devoir sélectionner les n-items voulus et remplir chaque étape
                  du build, nous pouvons maintenant le décrire en utilisant du
                  code ! Ainsi, en copiant/collant le script suivant dans la
                  partie idoine, vous devriez avoir un job bien configuré qui
                  marche, du premier coup !
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-groovy" data-lang="groovy">def m2Repo = '-v /var/jenkins_home/.m2:/home/jenkins/.m2' //  # <b class="conum">(1)</b>
def timezone = '-e TZ=Europe/Paris' // # <b class="conum">(2)</b>
docker.image("codetroopers/jenkins-slave-jdk8-restx")
    .inside("${m2Repo} ${timezone}"){ //  # <b class="conum">(3)</b>
    git branch: 'master', url: 'https://github.com/code-troopers/jenkins-workflow-demo-repo.git' // # <b class="conum">(4)</b>
    sh "MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage" // # <b class="conum">(5)</b>
    step([$class: 'ArtifactArchiver', artifacts: 'srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh']) // # <b class="conum">(6)</b>
    step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml']) // # <b class="conum">(7)</b>
}</code></pre>
                </div>
              </div>
              <div class="colist arabic">
                <ol>
                  <li>
                    <p>
                      Partage du dépôt Maven local (pour gagner en temps de
                      build)
                    </p>
                  </li>
                  <li>
                    <p>
                      Export de la timezone (pour les tests unitaires de
                      l&#8217;exemple)
                    </p>
                  </li>
                  <li>
                    <p>
                      Démarrage du conteneur de build avec la bonne timezone
                      ainsi que le dépôt partagé
                    </p>
                  </li>
                  <li>
                    <p>Clonage des sources</p>
                  </li>
                  <li>
                    <p>Lancement du build (en forçant l&#8217;UTF-8)</p>
                  </li>
                  <li>
                    <p>Archivage des produits du build</p>
                  </li>
                  <li>
                    <p>Archivage des résultats des tests</p>
                  </li>
                </ol>
              </div>
              <div class="paragraph">
                <p>
                  Comme vous pouvez le voir, le script est relativement parlant
                  et permet en plus de s&#8217;affranchir du clickodrome de
                  configuration dans l&#8217;interface de Jenkins !
                </p>
              </div>
              <div class="paragraph">
                <p>
                  Il est intéressant de noter que l&#8217;image Docker qui sert
                  au build est une image personnalisée. Ce n&#8217;est pas parce
                  qu&#8217;elle inclut un quelconque fonctionnement permettant
                  de builder en utilisant le plugin Workflow. Elle sert de base
                  uniquement car elle met à disposition la partie
                  <code>npm</code> nécessaire au build de la partie
                  <em>frontend</em> de l&#8217;application RestX.
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="grouper-les-étapes">Grouper les étapes</h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Le plugin workflow permet en plus de grouper les différentes
                  étapes d&#8217;un build pour permettre, par exemple, de le
                  lancer sur plusieurs environnement différents. Ici nous
                  ajoutons simplement un nom de groupe pour notre étape de
                  build.
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-groovy" data-lang="groovy">stage 'build' // # <b class="conum">(1)</b>
    def m2Repo = '-v /var/jenkins_home/.m2:/home/jenkins/.m2'
    def timezone = '-e TZ=Europe/Paris'
    docker.image("codetroopers/jenkins-slave-jdk8-restx").inside("${m2Repo} ${timezone}"){
        git branch: 'master', url: 'https://github.com/code-troopers/jenkins-workflow-demo-repo.git'
        sh "MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage"
        step([$class: 'ArtifactArchiver', artifacts: 'srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh'])
        step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
    }</code></pre>
                </div>
              </div>
              <div class="colist arabic">
                <ol>
                  <li>
                    <p>
                      Étape nommée pour l&#8217;exécution de la construction de
                      l&#8217;application
                    </p>
                  </li>
                </ol>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="mettre-de-côté-les-fichiers-pour-plus-tard">
              Mettre de côté les fichiers pour plus tard
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  La notion de <em>stash</em> bien connue des utilisateurs de
                  git est également présente. Elle permet de mettre de côté des
                  fichiers pour les réutiliser à une étape ultérieure du
                  <em>workflow</em> de build. Ceci permet d&#8217;éviter
                  l&#8217;archivage de produits du build pour des raisons
                  "techniques".
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-groovy" data-lang="groovy">stage 'build'
    def m2Repo = '-v /var/jenkins_home/.m2:/home/jenkins/.m2'
    def timezone = '-e TZ=Europe/Paris'
    docker.image("codetroopers/jenkins-slave-jdk8-restx").inside("${m2Repo} ${timezone}"){
        git branch: 'master', url: 'https://github.com/code-troopers/jenkins-workflow-demo-repo.git'
        sh "MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage"
        step([$class: 'ArtifactArchiver', artifacts: 'srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh'])
        step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
        stash includes: 'run.sh,srv/target/dependency/webapp-runner.jar,srv/target/*.war,Dockerfile', name: 'dockerBuild' // # <b class="conum">(1)</b>
    }</code></pre>
                </div>
              </div>
              <div class="colist arabic">
                <ol>
                  <li>
                    <p>
                      Enregistrement d&#8217;une liste de fichiers associée à un
                      nom pour une utilisation ultérieure
                    </p>
                  </li>
                </ol>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="étape-de-construction-dune-image-docker">
              Étape de construction d&#8217;une image Docker
            </h2>
            <div class="sectionbody">
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-groovy" data-lang="groovy">stage 'docker' // # <b class="conum">(1)</b>
node{ // # <b class="conum">(2)</b>
  ws{ // # <b class="conum">(3)</b>
    unstash 'dockerBuild' // # <b class="conum">(4)</b>
    docker.build("codetroopers/jenkins-workflow-demo:${env.BUILD_ID}") // # <b class="conum">(5)</b>
  }
}</code></pre>
                </div>
              </div>
              <div class="colist arabic">
                <ol>
                  <li>
                    <p>Création d&#8217;une nouvelle étape</p>
                  </li>
                  <li>
                    <p>
                      Permet de distinguer un ensemble d&#8217;opération de
                      build (peut accepter les labels pour restreindre sur des
                      noeuds)
                    </p>
                  </li>
                  <li>
                    <p>
                      Déclenche la création d&#8217;un nouveau
                      <em>workspace</em>
                    </p>
                  </li>
                  <li>
                    <p>
                      Récupère les fichiers mis de côté sous le nom
                      <code>dockerBuild</code>
                    </p>
                  </li>
                  <li>
                    <p>
                      Construction d&#8217;une image docker avec pour tag le
                      numéro de build en cours (<code>$BUILD_ID</code>)
                    </p>
                  </li>
                </ol>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="workflow-et-gestion-multibranche">
              Workflow et gestion multibranche
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Dans nos façons de fonctionner qui sont maintenant devenues
                  habituelles, nous utilisons de façon intensives les branches
                  pour isoler nos développements. Un des points fastidieux est
                  de configurer un nouveau job Jenkins pour chaque branche afin
                  de valider son bon fonctionnement et ne pas se rendre compte
                  trop tard d&#8217;un build au rouge.
                </p>
              </div>
              <div class="paragraph">
                <p>
                  Le plugin 'Workflow Multibranch' simplifie de façon drastique
                  ce genre de cas, il suffit de rajouter un descripteur de build
                  dans les sources. Le fichier correspondant est tout simplement
                  appelé <code>Jenkinsfile</code>.
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-groovy" data-lang="groovy">stage 'build'
    def m2Repo = '-v /var/jenkins_home/.m2:/home/jenkins/.m2'
    def timezone = '-e TZ=Europe/Paris'
    docker.image("codetroopers/jenkins-slave-jdk8-restx").inside("${m2Repo} ${timezone}"){
        checkout scm // # <b class="conum">(1)</b>
        sh "MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage"
        step([$class: 'ArtifactArchiver', artifacts: 'srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh'])
        step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
        stash includes: 'run.sh,srv/target/dependency/webapp-runner.jar,srv/target/*.war,Dockerfile', name: 'dockerBuild'
    }

stage 'docker'
node{
  ws{
    unstash 'dockerBuild'
    docker.build("codetroopers/jenkins-workflow-demo:${env.BUILD_ID}")
  }
}</code></pre>
                </div>
              </div>
              <div class="colist arabic">
                <ol>
                  <li>
                    <p>
                      Il faut bien entendu remplacer l&#8217;endroit où nous
                      faisions le git clone pour qu&#8217;il soit dynamique par
                      rapport à ce qu&#8217;on construit. Le terme
                      <code>checkout scm</code> permet de s&#8217;assurer de ce
                      fonctionnement.
                    </p>
                  </li>
                </ol>
              </div>
              <div class="paragraph">
                <p>
                  L&#8217;intérêt est que chaque branche qui sera buildée
                  n&#8217;aura pas son historique mélangé avec une autre (là où
                  les jobs de validation de Pull Request ont tendance à tout
                  mélanger). De plus, un changement dans le process de build
                  sera directement versionné. Il n&#8217;y aura donc pas besoin
                  de penser à éditer le job lors du merge sur
                  <code>master</code> (on a tous vécu ce genre de situation
                  énervante) !
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="attendre-une-confirmation-utilisateur">
              Attendre une confirmation utilisateur
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Un des points intéressant de ce plugin est qu&#8217;il permet
                  la mise en pause des constructions. Ainsi, il est possible de
                  mettre en pause une construction correspondant à une livraison
                  et de lui faire attendre une validation manuelle par exemple.
                </p>
              </div>
              <div class="listingblock">
                <div class="content">
                  <pre
                    class="highlight"
                  ><code class="language-groovy" data-lang="groovy">stage 'build'
    def m2Repo = '-v /var/jenkins_home/.m2:/home/jenkins/.m2'
    def timezone = '-e TZ=Europe/Paris'
    docker.image("codetroopers/jenkins-slave-jdk8-restx").inside("${m2Repo} ${timezone}"){
        git branch: 'master', url: 'https://github.com/code-troopers/jenkins-workflow-demo-repo.git'
        sh "MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage"
        step([$class: 'ArtifactArchiver', artifacts: 'srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh'])
        step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
        stash includes: 'run.sh,srv/target/dependency/webapp-runner.jar,srv/target/*.war,Dockerfile', name: 'dockerBuild'
    }

stage 'docker'
node{
    ws{
        unstash 'dockerBuild'
        def built = docker.build("codetroopers/jenkins-workflow-demo:${env.BUILD_ID}")
        input 'Is everything ok ? Run app ?' // # <b class="conum">(1)</b>
        echo "We can run the docker-compose up here"
        def outcome = input message: 'We can even have parameters to answer this question', parameters: [ // # <b class="conum">(2)</b>
            [name: 'myChoice', description: 'My choice', choices: 'Choice 1\nChoice 2\nChoice 3', $class: 'ChoiceParameterDefinition']
        ]
        echo "You have chosen ${outcome}" // # <b class="conum">(3)</b>
    }
}</code></pre>
                </div>
              </div>
              <div class="colist arabic">
                <ol>
                  <li>
                    <p>
                      <code>input</code> met en pause la construction et permet
                      de continuer ou interrompre celle-ci
                    </p>
                  </li>
                  <li>
                    <p>
                      Il est également possible de permettre à
                      l&#8217;utilisateur de faire un choix
                    </p>
                  </li>
                  <li>
                    <p>
                      Ici la valeur sélectionnée par l&#8217;utilisateur est
                      écrite dans la sortie du build.
                    </p>
                  </li>
                </ol>
              </div>
              <div class="paragraph">
                <p>
                  <em
                    >J&#8217;espère que cet article vous donnera l&#8217;envie
                    d&#8217;essayer de rationnaliser un peu plus la
                    configuration de vos job Jenkins en les stockant dans votre
                    SCM</em
                  >
                </p>
              </div>
            </div>
          </div>
        </div>
        <!-- /.entry-content -->
      </article>
      <!-- /.hentry -->

      <article
        class="hentry"
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <header>
          <div class="entry-meta">
            <span class="entry-date date published updated"
              ><time
                datetime="2015-11-16T00:00:00+01:00"
                itemprop="datePublished"
                ><a
                  href="http://www.bloggure.info/redsocks-avoid-docker-proxy-headaches"
                  >November 16, 2015</a
                ></time
              ></span
            ><span
              class="author vcard"
              itemprop="author"
              itemscope
              itemtype="http://schema.org/Person"
              ><span itemprop="name" class="fn"
                ><a
                  href="http://www.bloggure.info/cgatay"
                  title="About cgatay"
                  itemprop="url"
                  >cgatay</a
                ></span
              ></span
            >&nbsp; &bull; &nbsp;<span class="entry-comments"
              ><a
                href="http://www.bloggure.info/redsocks-avoid-docker-proxy-headaches#disqus_thread"
                >Comment</a
              ></span
            >
          </div>
          <!-- /.entry-meta -->

          <h1 class="entry-title" itemprop="name">
            <a
              href="http://www.bloggure.info/redsocks-avoid-docker-proxy-headaches"
              rel="bookmark"
              title="Avoid Proxy Headaches in Docker with redsocks"
              itemprop="url"
              >Avoid Proxy Headaches in Docker with redsocks</a
            >
          </h1>
        </header>
        <div class="entry-content" itemprop="description">
          <h1 id="proxying-with-docker">Proxying with Docker</h1>

          <p>
            When using docker under a corporate proxy, it can be cumbersome to
            have a working networking in all containers. You often end up being
            blocked by specific network access which does not seem to be
            properly forwarded to the proper proxy. For example when using
            <code>apt</code>.
          </p>

          <h2 id="classic-way-of-doing">Classic way of doing</h2>

          <p>
            There is a
            <a
              href="https://docs.docker.com/engine/articles/systemd/#http-proxy"
              >documented way</a
            >
            of using a proxy, by adding command-line switches to your docker
            deamon. However, it does not seem to work everytime and could
            require exporting additional settings to your in-container
            applications (in my experience though).
          </p>

          <h2 id="why-not-using-docker">Why not using docker</h2>

          <p>
            <a href="https://github.com/ncarlier/">Nicolas</a> pointed me an
            image he created to help with the setup of a corporate proxy. It
            uses <a href="http://darkk.net.ru/redsocks/">redsocks</a> under the
            hood that listen to the docker socket and automatically add the glue
            to do the forwarding through the proxy.
          </p>

          <p>
            Easy proxying in docker is just one command away ! (fill in the
            blank of your proxy ip and port)
          </p>

          <pre><code>docker run \
       --restart=always \
       --privileged=true \
       --net=host \
       -d ncarlier/redsocks \
       $PROXY_IP $PROXY_PORT
</code></pre>
        </div>
        <!-- /.entry-content -->
      </article>
      <!-- /.hentry -->

      <article
        class="hentry"
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <header>
          <div class="entry-meta">
            <span class="entry-date date published updated"
              ><time
                datetime="2015-09-07T00:00:00+02:00"
                itemprop="datePublished"
                ><a href="http://www.bloggure.info/faster-ssh-multi-hop"
                  >September 07, 2015</a
                ></time
              ></span
            ><span
              class="author vcard"
              itemprop="author"
              itemscope
              itemtype="http://schema.org/Person"
              ><span itemprop="name" class="fn"
                ><a
                  href="http://www.bloggure.info/cgatay"
                  title="About cgatay"
                  itemprop="url"
                  >cgatay</a
                ></span
              ></span
            >&nbsp; &bull; &nbsp;<span class="entry-comments"
              ><a
                href="http://www.bloggure.info/faster-ssh-multi-hop#disqus_thread"
                >Comment</a
              ></span
            >
          </div>
          <!-- /.entry-meta -->

          <h1 class="entry-title" itemprop="name">
            <a
              href="http://www.bloggure.info/faster-ssh-multi-hop"
              rel="bookmark"
              title="Faster ssh multi hop"
              itemprop="url"
              >Faster ssh multi hop</a
            >
          </h1>
        </header>
        <div class="entry-content" itemprop="description">
          <h1 id="multi-hop">Multi Hop</h1>

          <p>
            It is often required that, for security reason, you have to hop
            through a SSH gateway to access other machines. While this is
            perfectly fine and simple to do, it is often cumbersome to open a
            new session. However, with a small script you can speed up your
            access to machines even with such a restriction in place.
          </p>

          <h2 id="classical-way-of-hoping">Classical way of hop’ing</h2>

          <p>
            Let’s say our gateway is named <code>gateway</code> and our target
            host <code>myAppHost</code> the classical way of doing it would be :
          </p>

          <figure class="highlight">
            <pre><code class="language-bash" data-lang="bash">ssh gateway
you@gateway <span class="nv">$ </span><span class="nb">hostname
</span>gateway.my.tld
you@gateway <span class="nv">$ </span>ssh myAppHost
you@myAppHost <span class="nv">$ </span><span class="nb">hostname
</span>myAppHost.my.tld
   </code></pre>
          </figure>

          <h2 id="faster-way-of-hoping">Faster way of hop’ing</h2>

          <p>
            A quicker way of doing this is to specify the ssh command directly,
            there is one thing to tell ssh though: allocating a TTY even if it
            does not seem to be connected to one. In fact, the command supplied
            to ssh is not supposed to be interactive, that is why you need to
            give this hint to SSH :
          </p>

          <figure class="highlight">
            <pre><code class="language-bash" data-lang="bash">ssh <span class="nt">-t</span> gateway ssh myAppHost
you@myAppHost <span class="nv">$ </span><span class="nb">hostname
</span>myAppHost.my.tld
   </code></pre>
          </figure>

          <h2 id="script-this-">Script this !</h2>
          <p>The script is really simple, and only consists in the following</p>

          <figure class="highlight">
            <pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>
ssh <span class="nt">-t</span> gateway ssh <span class="nv">$1</span>
   </code></pre>
          </figure>

          <p>
            Save this in your path and give it the run permission then you are
            all set (mine is named <code>gssh</code>). All you have to do to
            connect is now a simple <code>gssh myAppHost</code>
          </p>
        </div>
        <!-- /.entry-content -->
      </article>
      <!-- /.hentry -->

      <div class="pagination">
        <a href="http://www.bloggure.info/page2" class="btn">Previous</a>

        <ul class="inline-list">
          <li>
            <a href="http://www.bloggure.info/">1</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page2">2</a>
          </li>

          <li>
            <span class="current-page">3</span>
          </li>

          <li>
            <a href="http://www.bloggure.info/page4">4</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page5">5</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page6">6</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page7">7</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page8">8</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page9">9</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page10">10</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page11">11</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page12">12</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page13">13</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page14">14</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page15">15</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page16">16</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page17">17</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page18">18</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page19">19</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page20">20</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page21">21</a>
          </li>

          <li>
            <a href="http://www.bloggure.info/page22">22</a>
          </li>
        </ul>

        <a href="http://www.bloggure.info/page4" class="btn">Next</a>
      </div>
    </div>
    <!-- /#main -->

    <div class="footer-wrapper">
      <footer role="contentinfo">
        <span>
          See also
          <dl>
            <dt><a href="https://www.9h41.org">9h41</a></dt>
            <dt><a href="https://www.psy-tours.fr">Psy-Tours</a></dt>
          </dl>
        </span>
        <br />
        <span>
          &copy; 2026 . Powered by
          <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using a theme
          based on
          <a
            href="https://mademistakes.com/work/hpstr-jekyll-theme/"
            rel="nofollow"
            >HPSTR</a
          >.
        </span>
      </footer>
    </div>
    <!-- /.footer-wrapper -->

    <script>
      (function () {
        function loadScript(src) {
          return new Promise(function (resolve, reject) {
            var script = document.createElement("script");
            script.src = src;
            script.defer = true;
            script.async = false;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        var jqCdn =
          "//ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js";
        var jqLocal =
          "http://www.bloggure.info/assets/js/vendor/jquery-3.7.1.min.js";
        var needFitVids = document.querySelector(
          "article iframe, article video"
        );
        var needMagnific = document.querySelector(
          'a[href$=".jpg" i],a[href$=".jpeg" i],a[href$=".png" i],a[href$=".gif" i]'
        );

        var jqPromise = loadScript(jqCdn)
          .catch(function () {
            return loadScript(jqLocal);
          })
          .then(function () {
            if (!window.jQuery) {
              return loadScript(jqLocal);
            }
          });

        jqPromise
          .then(function () {
            var chain = Promise.resolve();

            return chain;
          })
          .then(function () {
            return loadScript(
              "http://www.bloggure.info/assets/js/scripts.min.js"
            );
          });
      })();
    </script>

    <!-- Asynchronous Google Analytics snippet -->
    <script>
      (function (i, s, o, g, r, a, m) {
        i["GoogleAnalyticsObject"] = r;
        (i[r] =
          i[r] ||
          function () {
            (i[r].q = i[r].q || []).push(arguments);
          }),
          (i[r].l = 1 * new Date());
        (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
      })(
        window,
        document,
        "script",
        "//www.google-analytics.com/analytics.js",
        "ga"
      );

      ga("create", "UA-11718843-3", "auto");
      ga("require", "linkid", "linkid.js");
      ga("send", "pageview");
    </script>

    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = "thereisnoplacelike1"; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
        var dsq = document.createElement("script");
        dsq.type = "text/javascript";
        dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (
          document.getElementsByTagName("head")[0] ||
          document.getElementsByTagName("body")[0]
        ).appendChild(dsq);
      })();

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
        var s = document.createElement("script");
        s.async = true;
        s.type = "text/javascript";
        s.src = "//" + disqus_shortname + ".disqus.com/count.js";
        (
          document.getElementsByTagName("HEAD")[0] ||
          document.getElementsByTagName("BODY")[0]
        ).appendChild(s);
      })();
    </script>
    <noscript
      >Please enable JavaScript to view the
      <a href="http://disqus.com/?ref_noscript"
        >comments powered by Disqus.</a
      ></noscript
    >
    <a href="http://disqus.com" class="dsq-brlink"
      >comments powered by <span class="logo-disqus">Disqus</span></a
    >
  </body>
</html>
