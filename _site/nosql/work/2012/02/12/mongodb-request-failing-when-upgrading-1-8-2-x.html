<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bloggure - mongoDB request failing when upgrading (1.8 > 2.x)</title>
  <meta name="author" content="Bloggure" />
  <meta name="description" content="The blog of Bloggure" />
  <link rel="canonical" href="http://bloggure.info/nosql/work/2012/02/12/mongodb-request-failing-when-upgrading-1-8-2-x.html" />

  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Bloggure" href="http://bloggure.info/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
<!--[if IE 7]>
  <link rel="stylesheet" href="/assets/css/font-awesome-ie7.min.css">
<![endif]-->
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <a href="/">
    <img src="/logo.png" id="logo" alt="Blog logo"/>
  </a>
  <h2><a href="/">Bloggure</a></h2>
  <hr/>
  <ul>
  <p>localhosting since 2005</p>
  <hr/>
  <div>
    <div id="social">
      Follow us:
<div id="stalker">
  
  <a title="bloggure on Github" href="http://github.com/bloggure">
    <i class="icon-github-sign"></i>
  </a>
  

  
  <a title="bloggure on Hacker News" href="http://news.ycombinator.com/user?id=bloggure">
    <i class="icon-sign-blank"></i>
    <span class="icon-overlay icon-hn">Y</span>
  </a>
  

  
  <a title="bloggure on Twitter" href="http://twitter.com/bloggure">
    <i class="icon-twitter-sign"></i>
  </a>
  

  <a title="RSS feed" id="rss" href="/atom.xml">
    <i class="icon-rss-sign"></i>
  </a>
</div>
    </div>
  </div>
  </ul>
</nav>
    </div>

    <div class="eleven columns content">
      <p class="meta">
  February 12, 2012 
  <a href="/">
    <i class="home icon-home"></i>
  </a>
</p>

<h1 class="title">mongoDB request failing when upgrading (1.8 > 2.x)</h1>

<div id="post">
  <!--:en-->At work we faced a strange issue with mongoDB 2.x. Whereas our requests were working perfectly with mongoDB 1.8 we always got errors. The message mongoDB was firing at us was of the form : 

<pre class="brush: java">
Caused by: com.mongodb.MongoException: assertion db/../bson/bsonobjbuilder.h:127
       at com.mongodb.MongoException.parse(MongoException.java:82)
</pre>
<img src="http://www.bloggure.info/wp-content/uploads/2012/02/mongo.png" alt="" title="mongoDB leaf" width="128" height="128" class="alignright size-full wp-image-507" />
I found the following issue in <a href="https://jira.mongodb.org/browse/SERVER-3846">mongoDB's Jira</a> but apparently nothing to do with our requests (we are not using empty properties indexes), it takes me a lot of time to figure out that, at times, our request were sorted on empty properties (<a href="https://jira.mongodb.org/browse/SERVER-3874">as stated here</a>). The fix is really simple, <strong>do not sort on empty properties</strong> !

As it takes me times to find this and I did not find any blog post explaining this, I hope it will help another developer.<!--:--><!--:fr-->Nous avons rencontré un problème assez étrange avec mongoDB 2.x. Alors que nos requêtes existantes marchaient sans aucun soucis avec mongoDB 1.8. mongoDB répondait invariablement avec l'erreur suivante :

<pre class="brush: java">
Caused by: com.mongodb.MongoException: assertion db/../bson/bsonobjbuilder.h:127
       at com.mongodb.MongoException.parse(MongoException.java:82)
</pre>
<img src="http://www.bloggure.info/wp-content/uploads/2012/02/mongo.png" alt="" title="mongoDB leaf" width="128" height="128" class="alignright size-full wp-image-507" />
J'ai bien sur trouvé le bug suivant sur <a href="https://jira.mongodb.org/browse/SERVER-3846">le Jira du projet mongoDB</a> mais apparement rien à voir avec nos requêtes (nous n'avons pas d'index sur des propriétés vides). Cela m'a pris pas mal de temps avant de comprendre que, parfois, nos requêtes étaient parfois triées sur des propriétés vides (<a href="https://jira.mongodb.org/browse/SERVER-3874">comme précisé ici</a>).
Le correctif est vraiment simple, <strong>ne triez pas sur des propriétés vides</strong> !

Puisque j'ai mis pas mal de temps à comprendre ce qui se passait et que je n'ai trouvé aucun billet relatif, j'espère que ça aidera un autre développeur.<!--:-->

</div>

<!-- <div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>24 Oct 2010 &raquo;</span> <a href="/.wicket/2010/10/24/wicket-1-4-9-tinymce.html">Wicket 1.4.x - TinyMCE</a>
    </li>
    
    <li>
      <span>29 Oct 2010 &raquo;</span> <a href="/.android/2010/10/29/android-switcher-widget.html">Android Switcher Widget</a>
    </li>
    
    <li>
      <span>01 Nov 2010 &raquo;</span> <a href="/.java/.maven/work/2010/11/01/getting-source-revision-for-a-deployed-app-using-maven-and-a-servlet.html">Getting source revision for a deployed app using Maven and a Servlet</a>
    </li>
    
  </ul>
</div> -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thereisnoplacelike1'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
      <div class="footer">
        <div class="disclaimer">
  
  <p>
    The postings on this site are my own and don't necessarily represent my 
    employer’s positions, strategies or opinions.
  </p>
  

  <p>
    © Bloggure, 2013 &mdash; built with Jekyll using Lagom theme
  </p>
</div>
      </div>
    </div>
  </div>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-xxxx-x']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>