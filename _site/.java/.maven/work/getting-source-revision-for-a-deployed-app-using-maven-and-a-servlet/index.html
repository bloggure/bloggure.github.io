<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Getting source revision for a deployed app using Maven and a Servlet &#8211; Site Title</title>
<meta name="description" content="Describe your website here.">
<meta name="keywords" content="java, maven, scm, servlet">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Getting source revision for a deployed app using Maven and a Servlet">
<meta property="og:description" content="Describe your website here.">
<meta property="og:url" content="/.java/.maven/work/getting-source-revision-for-a-deployed-app-using-maven-and-a-servlet">
<meta property="og:site_name" content="Site Title">





<link rel="canonical" href="/.java/.maven/work/getting-source-revision-for-a-deployed-app-using-maven-and-a-servlet">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Site Title Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.min.css">
<!-- Webfonts -->
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post"  itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Your Name photo" class="author-photo">
					<h4>Your Name</h4>
					<p>Your bio goes here. It shouldn't be super long but a good two sentences or two should suffice.</p>
				</li>
				<li><a href="/about/">Learn More</a></li>
				<li>
					<a href="mailto:you@email.com"><i class="icon-envelope"></i> Email</a>
				</li>
				
				
				
				
				
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/archive/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		<li><a href="/theme-setup">Theme Setup</a></li><li><a href="http://mademistakes.com">External Link</a></li>
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
  <article class="hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title" itemprop="name"><a href="/.java/.maven/work/getting-source-revision-for-a-deployed-app-using-maven-and-a-servlet" rel="bookmark" title="Getting source revision for a deployed app using Maven and a Servlet" itemprop="url">Getting source revision for a deployed app using Maven and a Servlet</a></h1>
        
        <h2>November 01, 2010</h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content" itemprop="description">
      <!--:en--><img class="alignright size-full wp-image-74" src="http://www.bloggure.info/wp-content/uploads/2010/11/Maven_logo1.gif" alt="" width="274" height="70" />With our modern version control systems, we could assume we know for every single release we make the exact source code revision that corresponds. But, in the hurry of a bug found by your dear clients (or your product owner),  you can't find the corresponding tag in your VCS, it will make the whole patch process really difficult. You will have to find the exact revision, extract it and debug to patch (or backport an existing patch).

I will explain a little trick to make the find the revision thing a lot easier (I am assuming you're using maven to build your projects) : <a title="maven-buildnumber-plugin" href="http://mojo.codehaus.org/buildnumber-maven-plugin/">maven-buildnumber-plugin</a>

<!--:--><!--:fr--><em>Cet article n'a pas été traduit, veuillez trouver ci-dessous sa version anglaise</em>

<img class="alignright size-full wp-image-74" src="http://www.bloggure.info/wp-content/uploads/2010/11/Maven_logo1.gif" alt="" width="274" height="70" />With our modern version control systems, we could assume we know for every single release we make the exact source code revision that corresponds. But, in the hurry of a bug found by your dear clients (or your product owner),  you can't find the corresponding tag in your VCS, it will make the whole patch process really difficult. You will have to find the exact revision, extract it and debug to patch (or backport an existing patch).

I will explain a little trick to make the find the revision thing a lot easier (I am assuming you're using maven to build your projects) : <a title="maven-buildnumber-plugin" href="http://mojo.codehaus.org/buildnumber-maven-plugin/">maven-buildnumber-plugin</a>

<!--:--><!--more--><!--:en-->
<h2>Embed revision into artifacts</h2>
By using this plugin you can easily embbed revision informations into your artifacts, the configuration is, as always with maven, as easy as A-B-C, just add the following to your projects' pom :

[code lang="xml"]
&lt;profile&gt;
    &lt;id&gt;buildnumbering&lt;/id&gt;
    &lt;build&gt;
       &lt;plugins&gt;
           &lt;plugin&gt;
               &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
               &lt;artifactId&gt;buildnumber-maven-plugin&lt;/artifactId&gt;
               &lt;version&gt;1.0-beta-4&lt;/version&gt;
               &lt;executions&gt;
                  &lt;execution&gt;
                     &lt;phase&gt;validate&lt;/phase&gt;
                     &lt;goals&gt;
                         &lt;goal&gt;create&lt;/goal&gt;
                     &lt;/goals&gt;
                 &lt;/execution&gt;
               &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                       &lt;id&gt;buildNumber&lt;/id&gt;
                       &lt;configuration&gt;
                          &lt;archive&gt;
                             &lt;manifestEntries&gt;
                                &lt;Implementation-Build&gt;
                                      ${buildNumber}
                                &lt;/Implementation-Build&gt;
                             &lt;/manifestEntries&gt;
                          &lt;/archive&gt;
                      &lt;/configuration&gt;
                   &lt;/execution&gt;
               &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-ear-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                   &lt;archive&gt;
                      &lt;manifestEntries&gt;
                         &lt;Implementation-Build&gt;
                               ${buildNumber}
                         &lt;/Implementation-Build&gt;
                      &lt;/manifestEntries&gt;
                   &lt;/archive&gt;
                &lt;/configuration&gt;
             &lt;/plugin&gt;
         &lt;/plugins&gt;
     &lt;/build&gt;
&lt;/profile&gt;
[/code]

We tell maven to use the maven-build-number plugin during the validate phase and we add the property <em>buildNumber </em>to the manifest entries of the ear and war we can produce (useful if we are in a multimodule pom). This setup is performed under a specific profile and can be triggered by executing maven this way :

[code lang="bash"]mvn clean install -Pbuildnumbering[/code]

If you look at resulting artifacts, the META-INF/MANIFEST.MF files contain Implementation-Build: #### (where #### is the current revision on your SCM).
<h2>Get revision number at runtime</h2>
Now that the revision is stored in our artifacts, we need a way to figure out, at runtime, which revision is deployed, the basic idea is to have a servlet get this info for us, and dump it on your web browser. For confidentiality purpose, it might be useful to put an authorization filter on top of this servlet, but it won't be covered in this post.

The code for the servlet follows :

[code lang="java"]
/**
  * Package and import are ommited on purpose
  * User: cgatay Date: 17 oct. 2010 Time: 13:34:59
  */
public class VersionServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            String appServerHome = getServletContext().getContext(&quot;/&quot;).getRealPath(&quot;/&quot;);
            final int lastSlash = appServerHome.lastIndexOf(File.separator);
            final int beforeLastSlash = appServerHome.lastIndexOf(File.separator, lastSlash-1);
            appServerHome = appServerHome.substring(0, beforeLastSlash);

            final File file = new File(appServerHome);
            if (file.exists() &amp;&amp; file.canRead() &amp;&amp; file.isDirectory()) {
                List&lt;String&gt; listFiles = new ArrayList&lt;String&gt;(Arrays.asList(file.list()));
                listFiles.add(0, &quot;&quot;);
                for (String s : listFiles) {
                    File manifestFile = new File(appServerHome + File.separator + s, &quot;META-INF/MANIFEST.MF&quot;);
                    if (manifestFile.exists()) {
                        dumpManifestInfo(resp, manifestFile, s);
                    }
                }
            }
            resp.setStatus(200);
        } catch (IOException e) {
            e.printStackTrace();
            resp.setStatus(500);
            resp.getOutputStream().print(&quot;Cannot retrieve version data !&quot;);
        }
    }

    private void dumpManifestInfo(HttpServletResponse resp, File manifestFile, String module) throws IOException {
        Manifest mf = new Manifest();
        mf.read(new FileInputStream(manifestFile));

        Attributes atts = mf.getMainAttributes();
        resp.getOutputStream().println(&quot; ============================ &quot;);
        resp.getOutputStream().println(&quot;Module : &quot; + (module.isEmpty() ? &quot;EAR&quot; : module));
        resp.getOutputStream().println(&quot;Build: &quot; + atts.getValue(&quot;Implementation-Build&quot;));
    }
}

[/code]

Just mount this Servlet via your web.xml, add a filter on top and you're gone.

We assume that if the module is empty, we are at the root of an EAR file.

This is confirmed to work under Glassfish application server, it might work with other application servers (path might need to be corrected), anyway, I'd love to get feedback on this.<!--:--><!--:fr-->
<h2>Embed revision into artifacts</h2>
By using this plugin you can easily embbed revision informations into your artifacts, the configuration is, as always with maven, as easy as A-B-C, just add the following to your projects' pom :

[code lang="xml"]
&lt;profile&gt;
    &lt;id&gt;buildnumbering&lt;/id&gt;
    &lt;build&gt;
       &lt;plugins&gt;
           &lt;plugin&gt;
               &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
               &lt;artifactId&gt;buildnumber-maven-plugin&lt;/artifactId&gt;
               &lt;version&gt;1.0-beta-4&lt;/version&gt;
               &lt;executions&gt;
                  &lt;execution&gt;
                     &lt;phase&gt;validate&lt;/phase&gt;
                     &lt;goals&gt;
                         &lt;goal&gt;create&lt;/goal&gt;
                     &lt;/goals&gt;
                 &lt;/execution&gt;
               &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                       &lt;id&gt;buildNumber&lt;/id&gt;
                       &lt;configuration&gt;
                          &lt;archive&gt;
                             &lt;manifestEntries&gt;
                                &lt;Implementation-Build&gt;
                                      ${buildNumber}
                                &lt;/Implementation-Build&gt;
                             &lt;/manifestEntries&gt;
                          &lt;/archive&gt;
                      &lt;/configuration&gt;
                   &lt;/execution&gt;
               &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-ear-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                   &lt;archive&gt;
                      &lt;manifestEntries&gt;
                         &lt;Implementation-Build&gt;
                               ${buildNumber}
                         &lt;/Implementation-Build&gt;
                      &lt;/manifestEntries&gt;
                   &lt;/archive&gt;
                &lt;/configuration&gt;
             &lt;/plugin&gt;
         &lt;/plugins&gt;
     &lt;/build&gt;
&lt;/profile&gt;
[/code]

We tell maven to use the maven-build-number plugin during the validate phase and we add the property <em>buildNumber </em>to the manifest entries of the ear and war we can produce (useful if we are in a multimodule pom). This setup is performed under a specific profile and can be triggered by executing maven this way :

[code lang="bash"]mvn clean install -Pbuildnumbering[/code]

If you look at resulting artifacts, the META-INF/MANIFEST.MF files contain Implementation-Build: #### (where #### is the current revision on your SCM).
<h2>Get revision number at runtime</h2>
Now that the revision is stored in our artifacts, we need a way to figure out, at runtime, which revision is deployed, the basic idea is to have a servlet get this info for us, and dump it on your web browser. For confidentiality purpose, it might be useful to put an authorization filter on top of this servlet, but it won't be covered in this post.

The code for the servlet follows :

[code lang="java"]
/**
  * Package and import are ommited on purpose
  * User: cgatay Date: 17 oct. 2010 Time: 13:34:59
  */
public class VersionServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            String appServerHome = getServletContext().getContext(&quot;/&quot;).getRealPath(&quot;/&quot;);
            final int lastSlash = appServerHome.lastIndexOf(File.separator);
            final int beforeLastSlash = appServerHome.lastIndexOf(File.separator, lastSlash-1);
            appServerHome = appServerHome.substring(0, beforeLastSlash);

            final File file = new File(appServerHome);
            if (file.exists() &amp;&amp; file.canRead() &amp;&amp; file.isDirectory()) {
                List&lt;String&gt; listFiles = new ArrayList&lt;String&gt;(Arrays.asList(file.list()));
                listFiles.add(0, &quot;&quot;);
                for (String s : listFiles) {
                    File manifestFile = new File(appServerHome + File.separator + s, &quot;META-INF/MANIFEST.MF&quot;);
                    if (manifestFile.exists()) {
                        dumpManifestInfo(resp, manifestFile, s);
                    }
                }
            }
            resp.setStatus(200);
        } catch (IOException e) {
            e.printStackTrace();
            resp.setStatus(500);
            resp.getOutputStream().print(&quot;Cannot retrieve version data !&quot;);
        }
    }

    private void dumpManifestInfo(HttpServletResponse resp, File manifestFile, String module) throws IOException {
        Manifest mf = new Manifest();
        mf.read(new FileInputStream(manifestFile));

        Attributes atts = mf.getMainAttributes();
        resp.getOutputStream().println(&quot; ============================ &quot;);
        resp.getOutputStream().println(&quot;Module : &quot; + (module.isEmpty() ? &quot;EAR&quot; : module));
        resp.getOutputStream().println(&quot;Build: &quot; + atts.getValue(&quot;Implementation-Build&quot;));
    }
}

[/code]

Just mount this Servlet via your web.xml, add a filter on top and you're gone.

We assume that if the module is empty, we are at the root of an EAR file.

This is confirmed to work under Glassfish application server, it might work with other application servers (path might need to be corrected), anyway, I'd love to get feedback on this.<!--:-->

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/index.html#java" title="Pages tagged java" rel="tag" class="tag">java</a><a href="/tags/index.html#maven" title="Pages tagged maven" rel="tag" class="tag">maven</a><a href="/tags/index.html#scm" title="Pages tagged scm" rel="tag" class="tag">scm</a><a href="/tags/index.html#servlet" title="Pages tagged servlet" rel="tag" class="tag">servlet</a></span>
        <span><a href="/.java/.maven/work/getting-source-revision-for-a-deployed-app-using-maven-and-a-servlet" rel="bookmark" title="Getting source revision for a deployed app using Maven and a Servlet" itemprop="url">Getting source revision for a deployed app using Maven and a Servlet</a></span>
        was published on <span class="entry-date date published updated"><time datetime="2010-11-01T00:00:00-04:00" itemprop="datePublished">November 01, 2010</span></time>
        
        <span class="author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="fn"><a href="/about" title="About Your Name" itemprop="url">Your Name</a></span></span>
        
      </footer>
    </div><!-- /.entry-content -->
    
    
    <div class="read-more">
      
        <div class="read-more-header">
          <a href="/.android/android-switcher-widget" class="read-more-btn">Read More</a>
        </div><!-- /.read-more-header -->
        <div class="read-more-content">
          <h3><a href="/.wicket/wicket-1-4-9-tinymce" title="Wicket 1.4.x - TinyMCE">Wicket 1.4.x - TinyMCE</a></h3>
          <p>With our modern version control systems, we could assume we know for every single release we make the exact source code revision that cor...&hellip; <a href="/.wicket/wicket-1-4-9-tinymce">Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="/.android/android-switcher-widget" title="Android Switcher Widget">Android Switcher Widget</a></h4>
            <span>Published on October 29, 2010</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="/.java/work/glassfish-v3-custom-log-levels" title="Glassfish v3.x - custom log levels">Glassfish v3.x - custom log levels</a></h4>
            <span>Published on November 02, 2010</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
      
    </div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2013 Your Name. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>

	        

</body>
</html>
